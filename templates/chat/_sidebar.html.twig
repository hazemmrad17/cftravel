<aside id="chat-sidebar" class="sidebar-smooth fixed inset-y-0 top-16 right-0 z-40 bg-[#e5e7eb] dark:bg-dark-primary border-l border-gray-100 dark:border-gray-800 transform lg:translate-x-0 lg:static lg:h-auto translate-x-full" 
	:class="{
		'translate-x-0': rightSidebarOpen, 
		'translate-x-full': !rightSidebarOpen,
		'w-[288px]': !rightSidebarCollapsed && window.innerWidth >= 1024,
		'w-[80px]': rightSidebarCollapsed && window.innerWidth >= 1024
	}">
    <div class="h-full flex flex-col p-4">
        <!-- Toggle Button for Right Sidebar -->
        <div class="flex justify-start lg:block mb-4">
            <button @click="rightSidebarCollapsed = !rightSidebarCollapsed" 
                class="sidebar-toggle-btn lg:absolute lg:top-6 lg:-left-3 p-2 rounded-full bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 text-gray-600 dark:text-gray-400 shadow-lg border border-gray-200 dark:border-gray-600"
                x-show="window.innerWidth >= 1024">
                <svg x-show="!rightSidebarCollapsed" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                </svg>
                <svg x-show="rightSidebarCollapsed" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                </svg>
            </button>
        </div>
        
        <!-- Collapsed Right Sidebar Content -->
        <div class="sidebar-wrapper flex flex-col items-center space-y-4" 
            x-show="rightSidebarCollapsed && window.innerWidth >= 1024"
            x-transition:enter="sidebar-slide-in-right"
            x-transition:leave="sidebar-slide-out-right">
            <!-- New Chat Icon -->
            <button type="button" class="w-12 h-12 flex items-center justify-center">
                <svg class="collapsed-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
            </button>
            
            <!-- Search Icon -->
            <div class="w-12 h-12 flex items-center justify-center">
                <svg class="collapsed-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </div>
            
            <!-- History Icon -->
            <div class="w-12 h-12 flex items-center justify-center">
                <svg class="collapsed-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3v18h18"/>
                    <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
                </svg>
            </div>
        </div>
        
        <div class="sidebar-wrapper" 
            x-show="!rightSidebarCollapsed || window.innerWidth < 1024"
            x-transition:enter="sidebar-slide-in-right"
            x-transition:leave="sidebar-slide-out-right">
            <!-- New Chat Button -->
            <button type="button" class="new-chat-btn w-full bg-gray-800 dark:bg-white/15 dark:hover:bg-white/25 font-medium text-sm hover:bg-gray-950 transition text-white py-3 px-5 rounded-full mb-4 flex items-center justify-center">
                Nouvelle Discussion
            </button>

            <!-- Enhanced Search Bar with better visibility -->
            <div class="pb-4">
                <div class="relative">
                    <input type="text" placeholder="Rechercher destinations ou offres..." class="w-full py-3 px-4 pr-12 dark:text-white dark:focus:border-gray-600 border border-gray-200 rounded-full dark:bg-dark-primary bg-white focus:outline-none focus:border-2 focus:border-blue-500 text-sm placeholder:text-sm placeholder:text-gray-500 dark:border-gray-700 dark:placeholder:text-white/30 shadow-sm">
                    <div class="absolute right-3.5 top-1/2 transform -translate-y-1/2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 16 16" fill="none">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M2.58347 7.49905C2.58347 4.78457 4.78456 2.58374 7.50013 2.58374C10.2157 2.58374 12.4168 4.78457 12.4168 7.49905C12.4168 10.2135 10.2157 12.4144 7.50013 12.4144C4.78456 12.4144 2.58347 10.2135 2.58347 7.49905ZM7.50013 1.08374C3.95647 1.08374 1.08347 3.9558 1.08347 7.49905C1.08347 11.0423 3.95647 13.9144 7.50013 13.9144C9.00119 13.9144 10.3819 13.399 11.4749 12.5357L13.6356 14.6966C13.9285 14.9895 14.4034 14.9895 14.6963 14.6966C14.9892 14.4037 14.9892 13.9289 14.6963 13.636L12.5359 11.4754C13.4006 10.3823 13.9168 9.00095 13.9168 7.49905C13.9168 3.9558 11.0438 1.08374 7.50013 1.08374Z" fill="#98A2B3"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conversation List with improved spacing -->
        <div class="sidebar-wrapper pb-4 overflow-y-auto custom-scrollbar pr-2" 
            x-show="!rightSidebarCollapsed || window.innerWidth < 1024"
            x-transition:enter="sidebar-slide-in-right"
            x-transition:leave="sidebar-slide-out-right">
            {% for group in [
              {'label': 'Aujourd\'hui', 'convs': conversationsToday},
              {'label': 'Hier', 'convs': conversationsYesterday},
              {'label': '7 derniers jours', 'convs': conversationsPrevious}
            ] %}
                {% if group.convs|length > 0 %}
                    <div class="py-4 border-b dark:border-gray-800 border-gray-200">
                        <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-300 mb-3 px-2">{{ group.label }}</h3>
                        <div class="space-y-1.5 w-full">
                            {% for conv in group.convs %}
                                <div class="px-1">
                                    <div class="chat-sidebar-item group flex items-center relative w-full mx-auto p-2.5 rounded-lg transition z-0
                                      {% if conv.id == currentConversationId %}bg-gray-200 text-gray-800{% else %}dark:hover:bg-white/5 hover:bg-gray-100 text-gray-800 dark:text-white/90{% endif %}" data-conversation-id="{{ conv.id }}">
                                      <a href="{{ path('chat_agent', {'agent': agent, 'conversation_id': conv.id}) }}" class="flex-1 min-w-0 truncate font-medium text-sm block w-full h-full chat-title">
                                        {{ conv.title ?? conv.preview|default('(Aucun message)') }}
                                      </a>
                                      <button type="button"
                                        class="conv-menu-btn ml-2 p-1 rounded hover:bg-gray-300 dark:hover:bg-gray-700 transition z-20 relative"
                                        data-action="menu"
                                        tabindex="-1" style="pointer-events:auto;">
                                        <svg width="20" height="20" fill="none"><circle cx="4" cy="10" r="2" fill="#888"/><circle cx="10" cy="10" r="2" fill="#888"/><circle cx="16" cy="10" r="2" fill="#888"/></svg>
                                      </button>
                                      <div class="menu-dropdown absolute right-0 top-10 bg-white border border-gray-200 rounded-xl shadow-lg min-w-[140px] z-50 flex-col py-2 hidden">
                                        <button class="conv-menu-action flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-action="rename">
                                          <svg width="16" height="16" class="mr-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                          </svg> Renommer
                                        </button>
                                        <button class="conv-menu-action flex items-center w-full px-4 py-2 text-sm text-red-700 dark:text-red-500 hover:bg-gray-100 hover:text-red-700 dark:hover:text-gray-100" data-action="delete" style="color: #dc2626 !important;">
                                          <svg width="16" height="16" class="mr-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                            <path d="M3 6h18"/>
                                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                            <line x1="10" y1="11" x2="10" y2="17"/>
                                            <line x1="14" y1="11" x2="14" y2="17"/>
                                          </svg> Supprimer
                                        </button>
                                      </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}

            <!-- Show More Button with better spacing -->
            <div class="px-2 mt-4">
                <button @click="showMoreHistory = !showMoreHistory" class="flex justify-between items-center text-red-600 dark:text-red-400 font-medium text-sm w-full p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 transition">
                    <span x-text="showMoreHistory ? 'Afficher moins...' : 'Afficher plus...'">Afficher plus...</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M3.83334 5.91673L8.00001 10.0834L12.1667 5.91673" stroke="#dc2626" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</aside>
