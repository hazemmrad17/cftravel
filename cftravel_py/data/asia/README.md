# Asia.fr Price Scraper

This directory contains the Asia.fr dataset and tools to scrape missing price information from their website.

## Files

- `data.json` - Original dataset from Asia.fr (contains all offer information except prices)
- `scraped_prices.json` - Scraped price data (generated by the scraper)
- `data_with_prices.json` - Merged dataset with prices included (generated by merge script)

## Usage

### 1. Install Dependencies

First, install the required dependencies:

```bash
pip install -r requirements.txt
```

### 2. Run the Price Scraper

The scraper will extract prices from Asia.fr using the `price_url` field from your dataset:

```bash
python scripts/scrape_asia_prices.py
```

**Features:**
- Respectful scraping with random delays (3-6 seconds between requests)
- Parallel processing (2 workers max to avoid overwhelming the server)
- Comprehensive error handling and logging
- Progress tracking and summary statistics

**Output:**
- `scraped_prices.json` - Contains scraped price data
- `asia_scraping.log` - Detailed logging information

### 3. Merge Prices into Dataset

After scraping, merge the prices back into your original dataset:

```bash
python scripts/merge_prices.py
```

This will create `data_with_prices.json` with the complete dataset including prices.

## Data Structure

### Original Offer Structure
```json
{
  "product_name": "Histoire de Jordanie",
  "reference": "TJOR1W",
  "price_url": "https://www.asia.fr/ceto.cfm?idproduit=115&ttc=1",
  "destinations": [...],
  "departure_city": "Paris",
  "dates": ["01/03/2025", "01/04/2025"],
  "duration": 8,
  // ... other fields
}
```

### Scraped Price Structure
```json
{
  "reference": "TJOR1W",
  "price": 1895.0,
  "currency": "EUR",
  "price_type": "per_person",
  "scraped_at": "2024-01-15 14:30:25",
  "url": "https://www.asia.fr/ceto.cfm?idproduit=115&ttc=1",
  "error": null
}
```

### Merged Offer Structure (with prices)
```json
{
  "product_name": "Histoire de Jordanie",
  "reference": "TJOR1W",
  "price": {
    "amount": 1895.0,
    "currency": "EUR",
    "price_type": "per_person",
    "scraped_at": "2024-01-15 14:30:25",
    "scraped_url": "https://www.asia.fr/ceto.cfm?idproduit=115&ttc=1",
    "scraping_error": null
  },
  // ... other original fields
}
```

## Scraping Strategy

The scraper uses multiple strategies to extract prices:

1. **Regex Patterns** - Looks for common price patterns in French:
   - `1 895 €`
   - `1895 EUR`
   - `Prix: 1 895 euros`
   - `À partir de 1 895 €`

2. **CSS Selectors** - Targets specific HTML elements:
   - `.price`, `.prix`
   - `[class*="price"]`, `[class*="prix"]`
   - `.tarif`, `.montant`

3. **Fallback** - If no price is found, the field is set to `null` with an error message

## Important Notes

- **Respectful Scraping**: The scraper includes random delays and limited concurrency to avoid overwhelming Asia.fr's servers
- **Error Handling**: Failed scrapes are logged with detailed error messages
- **Data Integrity**: The original dataset is never modified; new files are created for scraped and merged data
- **Logging**: All scraping activity is logged to `asia_scraping.log` for debugging

## Troubleshooting

### Common Issues

1. **No prices found**: The website structure may have changed. Check the log file for specific errors.

2. **Rate limiting**: If you get blocked, increase the delay range in the scraper configuration.

3. **Missing references**: Ensure all offers have valid `reference` and `price_url` fields.

### Manual Testing

You can test the scraper on a single offer:

```python
from cftravel_py.services.asia_scraper import AsiaScraper

scraper = AsiaScraper()
result = scraper.scrape_price_for_reference("TJOR1W", "https://www.asia.fr/ceto.cfm?idproduit=115&ttc=1")
print(f"Price: {result.price} {result.currency}")
```

## Legal Considerations

- This scraper is for educational/research purposes
- Always respect the website's robots.txt and terms of service
- Use reasonable delays between requests
- Consider reaching out to Asia.fr for official data access if needed for commercial use 